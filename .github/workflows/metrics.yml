name: Metrics Endpoint

on:
  push:
    paths:
      - "api/**"
      - "ops/Dockerfile"
      - "helm/**"
      - "grafana/**"
      - ".github/workflows/metrics.yml"
  pull_request:

permissions:
  contents: read
  packages: read

jobs:
  metrics:
    runs-on: ubuntu-latest
    env:
      IMAGE: 'dualsubstrate-metrics:test'
      FLY_ACCESS_TOKEN: ${{ secrets.FLY_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Login to Fly.io registry
        if: ${{ env.FLY_ACCESS_TOKEN != '' }}
        run: |
          echo "${FLY_ACCESS_TOKEN}" | \
            docker login registry.fly.io -u x --password-stdin
      - name: Build gRPC image
        run: docker build -t "$IMAGE" -f ops/Dockerfile .
      - name: Lightweight health ping
        run: |
          docker run --rm -d -p 9090:8080 --name metrics "$IMAGE"
          timeout 10 bash -c 'until curl -s localhost:9090/metrics > /dev/null; do sleep 1; done'
          echo "âœ… metrics up"
          docker stop metrics
