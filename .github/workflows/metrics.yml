name: Metrics Endpoint

on:
  push:
    paths:
      - "api/**"
      - "ops/Dockerfile"
      - "helm/**"
      - "grafana/**"
      - ".github/workflows/metrics.yml"
  pull_request:

permissions:
  contents: read
  packages: read

jobs:
  metrics:
    runs-on: ubuntu-latest
    env:
      IMAGE: 'dualsubstrate-metrics:test'
      FLY_ACCESS_TOKEN: ${{ secrets.FLY_ACCESS_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            docker login ghcr.io -u ${{ github.actor }} --password-stdin

      - name: Login to Fly.io registry
        if: ${{ env.FLY_ACCESS_TOKEN != '' }}
        run: |
          echo "${FLY_ACCESS_TOKEN}" | \
            docker login registry.fly.io -u x --password-stdin
      - name: Build gRPC image
        run: docker build -t "$IMAGE" -f ops/Dockerfile .
      - name: Check metrics endpoint
        run: |
          timeout 5 docker run --rm -p 9090:8080 "$IMAGE" &
          runner=$!
          sleep 3
          curl -f localhost:9090/metrics | grep -q grpc_server_handled_total
          wait "$runner" || true
