<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>DualSubstrate Browser Demo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 2rem auto;
        max-width: 720px;
        line-height: 1.5;
        color: #0f172a;
      }
      header {
        margin-bottom: 1.5rem;
      }
      section {
        border: 1px solid #cbd5f5;
        border-radius: 0.75rem;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 30px rgba(15, 23, 42, 0.05);
      }
      h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }
      label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.25rem;
      }
      input,
      textarea {
        width: 100%;
        padding: 0.65rem 0.75rem;
        border-radius: 0.5rem;
        border: 1px solid #cbd5f5;
        font-size: 1rem;
        font-family: inherit;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }
      input:focus,
      textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
      }
      button {
        background: linear-gradient(135deg, #2563eb, #7c3aed);
        color: white;
        border: none;
        border-radius: 999px;
        padding: 0.65rem 1.25rem;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.1s ease;
      }
      button:hover {
        transform: translateY(-1px);
        box-shadow: 0 10px 20px rgba(59, 130, 246, 0.25);
      }
      button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .status {
        margin-top: 0.75rem;
        padding: 0.75rem;
        border-radius: 0.5rem;
        background-color: #f1f5f9;
        font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
        white-space: pre-wrap;
      }
      .row {
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }
      .row > div {
        flex: 1 1 240px;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>DualSubstrate Browser Demo</h1>
      <p>
        Anchor a vector memory, rotate it about the Y-axis, and inspect the
        transformed state without leaving the browser.
      </p>
    </header>

    <section>
      <h2>1. Anchor Memory</h2>
      <div class="row">
        <div>
          <label for="memory">Memory Payload</label>
          <textarea id="memory" rows="4" placeholder='{"factors":["alpha","beta","gamma"]}'></textarea>
        </div>
        <div>
          <label for="entity">Entity ID</label>
          <input id="entity" type="text" value="demo-entity" />
        </div>
      </div>
      <button id="anchor-btn">Anchor Memory</button>
      <div id="anchor-status" class="status"></div>
    </section>

    <section>
      <h2>2. Rotate 90° around Y-axis</h2>
      <div class="row">
        <div>
          <label for="request-id">Anchor Request ID</label>
          <input id="request-id" type="text" placeholder="auto-filled after anchoring" />
        </div>
        <div>
          <label for="rotation-angle">Angle (degrees)</label>
          <input id="rotation-angle" type="number" value="90" />
        </div>
      </div>
      <button id="rotate-btn">Rotate 90° Y</button>
      <div id="rotate-status" class="status"></div>
    </section>

    <section>
      <h2>3. Query Rotated State</h2>
      <div class="row">
        <div>
          <label for="query-entity">Entity ID</label>
          <input id="query-entity" type="text" value="demo-entity" />
        </div>
      </div>
      <button id="query-btn">Query State</button>
      <div id="query-status" class="status"></div>
    </section>

    <script>
      const gatewayBase = window.location.origin;

      const anchorBtn = document.getElementById("anchor-btn");
      const rotateBtn = document.getElementById("rotate-btn");
      const queryBtn = document.getElementById("query-btn");

      const anchorStatus = document.getElementById("anchor-status");
      const rotateStatus = document.getElementById("rotate-status");
      const queryStatus = document.getElementById("query-status");

      const requestIdInput = document.getElementById("request-id");

      async function postJSON(path, body) {
        const response = await fetch(`${gatewayBase}${path}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify(body),
        });

        if (!response.ok) {
          const text = await response.text();
          throw new Error(`HTTP ${response.status}: ${text}`);
        }
        return response.json();
      }

      function setStatus(el, message, error = false) {
        el.textContent = message;
        el.style.color = error ? "#b91c1c" : "#0f172a";
      }

      anchorBtn.addEventListener("click", async () => {
        anchorBtn.disabled = true;
        setStatus(anchorStatus, "Anchoring...");
        try {
          const payload = document.getElementById("memory").value || "{}";
          const entity = document.getElementById("entity").value || "demo-entity";

          const data = await postJSON("/v1/anchor", {
            entity_id: entity,
            memory: payload,
          });
          requestIdInput.value = data.request_id ?? "";
          setStatus(
            anchorStatus,
            `Anchored request ${data.request_id || "<unknown>"} at ${data.timestamp || "now"}`
          );
        } catch (err) {
          setStatus(anchorStatus, err.message || String(err), true);
        } finally {
          anchorBtn.disabled = false;
        }
      });

      rotateBtn.addEventListener("click", async () => {
        rotateBtn.disabled = true;
        setStatus(rotateStatus, "Rotating...");
        try {
          const entity = document.getElementById("entity").value || "demo-entity";
          const requestId = requestIdInput.value;
          const angle = Number.parseFloat(document.getElementById("rotation-angle").value || "90");

          const data = await postJSON("/v1/rotate", {
            entity_id: entity,
            request_id: requestId,
            axis: "y",
            degrees: angle,
          });
          setStatus(rotateStatus, `Rotation checksum: ${data.checksum || "n/a"}`);
        } catch (err) {
          setStatus(rotateStatus, err.message || String(err), true);
        } finally {
          rotateBtn.disabled = false;
        }
      });

      queryBtn.addEventListener("click", async () => {
        queryBtn.disabled = true;
        setStatus(queryStatus, "Querying...");
        try {
          const entity = document.getElementById("query-entity").value || "demo-entity";
          const response = await fetch(`${gatewayBase}/v1/query?entity_id=${encodeURIComponent(entity)}`);
          if (!response.ok) {
            const text = await response.text();
            throw new Error(`HTTP ${response.status}: ${text}`);
          }
          const data = await response.json();
          setStatus(queryStatus, JSON.stringify(data, null, 2));
        } catch (err) {
          setStatus(queryStatus, err.message || String(err), true);
        } finally {
          queryBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
